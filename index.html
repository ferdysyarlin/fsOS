<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>fsOS</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Custom Styles -->
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    
    /* Custom Scrollbar Styling */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; } /* slate-100 */
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; } /* slate-400 */
    ::-webkit-scrollbar-thumb:hover { background: #64748b; } /* slate-500 */
    
    /* Active Navigation Link */
    .nav-link.active {
      background-color: #e2e8f0; /* slate-200 */
      color: #0f172a; /* slate-900 */
      font-weight: 600;
    }
    /* Masonry Layout Styling */
    .masonry-container {
      column-gap: 1rem;
    }
    .masonry-item {
      display: inline-block;
      width: 100%;
      margin-bottom: 1rem;
      break-inside: avoid;
    }
    @media (min-width: 640px) { .masonry-container { column-count: 2; } }
    @media (min-width: 1024px) { .masonry-container { column-count: 3; } }
    @media (min-width: 1280px) { .masonry-container { column-count: 4; } }

    @keyframes scale-in{0%{transform:scale(.95);opacity:0}100%{transform:scale(1);opacity:1}}
    .animate-scale-in{animation:scale-in .2s ease-out forwards}

    .color-swatch{width:20px;height:20px;border-radius:50%;cursor:pointer}
    .color-picker-popup .color-swatch{width:24px;height:24px;}
  </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased">

  <div class="flex h-screen overflow-hidden">
    <!-- Mobile Menu Backdrop -->
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="absolute md:relative z-30 w-64 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col transition-transform duration-300 -translate-x-full md:translate-x-0">
      <div class="h-16 flex items-center justify-between px-4 border-b border-slate-200">
        <h1 class="text-xl font-bold text-slate-900 nav-text">fsOS v.HTML</h1>
        <button id="sidebar-toggle" class="w-10 h-10 hidden md:flex items-center justify-center rounded-lg hover:bg-slate-100">
          <i id="toggle-icon" class="fa-solid fa-chevron-left text-slate-600"></i>
        </button>
      </div>
      
      <nav id="main-nav" class="flex-1 p-4 space-y-2">
        <a href="#" id="nav-dashboard" class="nav-link flex items-center px-3 py-2 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-100 active">
          <i class="fa-solid fa-chart-pie w-5 h-5 mr-3 text-center"></i>
          <span class="nav-text">Dashboard</span>
        </a>
        <a href="#" id="nav-kinerja" class="nav-link flex items-center px-3 py-2 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-100">
          <i class="fa-solid fa-desktop w-5 h-5 mr-3 text-center"></i>
          <span class="nav-text">Kinerja</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col relative">
      <header class="h-16 flex md:hidden items-center justify-between px-4 bg-white border-b border-slate-200">
        <button id="mobile-menu-button" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100">
          <i class="fa-solid fa-bars text-slate-600"></i>
        </button>
        <h1 class="text-lg font-bold text-slate-900">fsOS</h1>
        <div class="w-10"></div> <!-- Spacer -->
      </header>
      
      <main id="main-content" class="flex-1 p-2 md:p-6 overflow-y-auto">
        <!-- Konten dinamis akan dimuat di sini -->
      </main>
      
      <div id="add-button-container" class="absolute bottom-6 right-6 md:bottom-8 md:right-8" style="display: none;">
         <button id="add-data-btn" title="Tambah Data Baru" class="bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg transition-transform transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-indigo-300">
           <i class="fas fa-plus fa-lg"></i>
         </button>
      </div>
    </div>
  </div>
  
  <script>
    // !!! PENTING: Ganti dengan URL Web App Anda dari Google Apps Script !!!
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxfwuHgSGTW9d8blseHv5_p8oYXpc5bc6PR9Mt7ICI08Yh7aNFpXtGGpllQgUOciWw9/exec';

    // Palet Warna
    const softColors = {
      'default': { bg: 'bg-white', border: 'border-slate-200' },
      'yellow':  { bg: 'bg-yellow-50', border: 'border-yellow-200' },
      'blue':    { bg: 'bg-blue-50', border: 'border-blue-200' },
      'green':   { bg: 'bg-green-50', border: 'border-green-200' },
      'purple':  { bg: 'bg-purple-50', border: 'border-purple-200' },
      'pink':    { bg: 'bg-pink-50', border: 'border-pink-200' }
    };
    const colorPickerPalette = [
        { name: 'default', hex: '#FFFFFF', border: '#E2E8F0' },
        { name: 'yellow', hex: '#FEF9C3', border: '#FDE68A' },
        { name: 'blue', hex: '#DBEAFE', border: '#BFDBFE' },
        { name: 'green', hex: '#D1FAE5', border: '#A7F3D0' },
        { name: 'purple', hex: '#EDE9FE', border: '#DDD6FE' },
        { name: 'pink', hex: '#FCE7F3', border: '#FBCFE8' }
    ];

    /**
     * ===============================================
     * API Service Layer
     * ===============================================
     */
    const api = {
        async get(action, params = {}) {
            const url = new URL(GAS_URL);
            url.searchParams.append('action', action);
            for (const key in params) {
                url.searchParams.append(key, params[key]);
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            return response.json();
        },
        async post(action, payload) {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action, payload })
            });
            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            return response.json();
        }
    };


    /**
     * ===============================================
     * App Setup & Event Listeners
     * ===============================================
     */
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboard();
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => handleNavigation(e, link)));
        document.getElementById('add-data-btn').addEventListener('click', () => showEditModal(null));
        setupSidebar();
        
        // Listener global untuk menutup color picker
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.color-picker-popup') && !e.target.closest('.color-picker-toggle')) {
                const openPicker = document.querySelector('.color-picker-popup');
                if (openPicker) openPicker.remove();
            }
        });
    });

    function setupSidebar() {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const toggleIcon = document.getElementById('toggle-icon');
        const navTexts = document.querySelectorAll('.nav-text');
        const mainNav = document.getElementById('main-nav');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');

        if (sidebarToggle) sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('w-64');
            sidebar.classList.toggle('w-20');
            mainNav.classList.toggle('p-4');
            mainNav.classList.toggle('p-2');
            toggleIcon.classList.toggle('fa-chevron-left');
            toggleIcon.classList.toggle('fa-chevron-right');
            navTexts.forEach(text => text.classList.toggle('hidden'));
        });
         if (mobileMenuButton) mobileMenuButton.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            sidebarBackdrop.classList.remove('hidden');
         });
         if (sidebarBackdrop) sidebarBackdrop.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarBackdrop.classList.add('hidden');
         });
    }

    /**
     * ===============================================
     * Navigation & Page Loading
     * ===============================================
     */
    function handleNavigation(event, clickedLink) {
        event.preventDefault();
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        clickedLink.classList.add('active');
        if (window.innerWidth < 768) {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-backdrop').classList.add('hidden');
        }
        switch (clickedLink.id) {
            case 'nav-dashboard': loadDashboard(); break;
            case 'nav-kinerja': loadKinerjaData(); break;
        }
    }

    function loadDashboard() {
        document.getElementById('add-button-container').style.display = 'none';
        document.getElementById('main-content').innerHTML = `
            <div class="bg-white shadow-lg rounded-xl p-6">
              <h2 class="text-2xl font-bold text-slate-800">Selamat Datang di fsOS</h2>
              <p class="mt-2 text-slate-600">Pilih menu 'Kinerja' dari sidebar untuk melihat dan mengelola data.</p>
            </div>`;
    }

    async function loadKinerjaData() {
        showLoading('Memuat data kinerja...');
        document.getElementById('add-button-container').style.display = 'block';
        try {
            const response = await api.get('getSheetData');
            if (response.status === 'success') {
                displayCards(response.data);
            } else {
                showError(response.message);
            }
        } catch (error) {
            showError(error);
        }
    }
    
    /**
     * ===============================================
     * UI & Rendering Functions
     * ===============================================
     */
    function showLoading(message) {
        document.getElementById('main-content').innerHTML = `<div class="w-full text-center p-10"><i class="fas fa-spinner fa-spin fa-3x text-indigo-500"></i><p class="mt-4 text-gray-600">${message}</p></div>`;
    }

    function showError(error) {
        const errorMessage = typeof error === 'object' ? error.message : JSON.stringify(error);
        document.getElementById('main-content').innerHTML = `<div class="p-4 text-red-600 bg-red-100 rounded-lg"><strong>Error:</strong> ${errorMessage}</div>`;
    }

    function displayCards(dataRows) {
        const mainContent = document.getElementById('main-content');
        if (!dataRows || dataRows.length === 0) {
            mainContent.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm"><p>Tidak ada data. Klik tombol '+' untuk menambah data baru.</p></div>`;
            return;
        }
        
        let contentHtml = `<div class="masonry-container">`;
        dataRows.forEach((row) => {
            const idKinerja = row['ID Kinerja'];
            const colorClasses = softColors[row.Warna] || softColors['default'];
            const isPinned = row.Pin == 1;
            const sanitizedDeskripsi = JSON.stringify(row.Deskripsi);

            const pinButton = isPinned
                ? `<button onclick="event.stopPropagation(); togglePinStatus('${idKinerja}', ${isPinned})" title="Lepas Sematan" class="w-7 h-7 flex items-center justify-center text-indigo-600 hover:text-slate-500"><i class="fas fa-thumbtack"></i></button>`
                : `<button onclick="event.stopPropagation(); togglePinStatus('${idKinerja}', ${isPinned})" title="Sematkan" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-indigo-600"><i class="fas fa-thumbtack"></i></button>`;

            contentHtml += `
            <div id="card-${idKinerja}" 
                 class="masonry-item group relative ${colorClasses.bg} border ${colorClasses.border} rounded-xl shadow-sm hover:shadow-lg transition-shadow p-4 flex flex-col cursor-pointer" 
                 onclick="showEditModal('${idKinerja}')">
              
                <div class="absolute top-2 right-2 flex items-center space-x-1 bg-white/70 backdrop-blur-sm p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10">
                    <button onclick='event.stopPropagation(); copyDescription(${sanitizedDeskripsi}, this.querySelector("i"))' title="Salin Deskripsi" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-indigo-600"><i class="fas fa-copy"></i></button>
                    <button onclick="event.stopPropagation(); showColorPicker(event, '${idKinerja}')" title="Ubah Warna" class="color-picker-toggle w-7 h-7 flex items-center justify-center text-slate-500 hover:text-indigo-600"><i class="fas fa-palette"></i></button>
                    ${pinButton}
                    <button onclick="event.stopPropagation(); showDeleteConfirmation('${idKinerja}')" title="Hapus" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                </div>
                
                <div class="flex items-center mb-2">
                    ${isPinned ? `<div title="Disematkan" class="text-indigo-600 mr-2"><i class="fas fa-thumbtack fa-sm"></i></div>` : ''}
                    <p class="text-xs text-slate-500">${row.Tanggal || ''}</p>
                </div>

                ${row.Foto ? `<a href="${row.Foto}" target="_blank" class="block my-3"><img src="https://drive.google.com/thumbnail?id=${extractIdFromUrl(row.Foto)}&sz=w500" alt="Foto Kinerja" class="rounded-md w-full object-cover"></a>` : ''}
              
                <p class="text-slate-800 text-sm whitespace-pre-wrap">${row.Deskripsi || '<i>Tanpa Deskripsi</i>'}</p>
            </div>`;
        });
        contentHtml += '</div>';
        mainContent.innerHTML = contentHtml;
    }
    
    /**
     * ===============================================
     * Fitur Kartu (Copy, Color, Pin)
     * ===============================================
     */
    function copyDescription(text, iconElement) {
        navigator.clipboard.writeText(text).then(() => {
            const originalIconClass = iconElement.className;
            iconElement.className = 'fas fa-check text-green-500';
            setTimeout(() => { iconElement.className = originalIconClass; }, 1500);
        });
    }

    function showColorPicker(event, idKinerja) {
        event.stopPropagation();
        let existingPicker = document.querySelector('.color-picker-popup');
        if (existingPicker) existingPicker.remove();
        
        const picker = document.createElement('div');
        picker.className = 'color-picker-popup absolute z-20 bg-white rounded-lg shadow-lg p-2 flex gap-2';
        picker.innerHTML = colorPickerPalette.map(color => 
            `<div class="color-swatch" style="background-color:${color.hex};border:2px solid ${color.border};" onclick="updateCardColor('${idKinerja}', '${color.name}')"></div>`
        ).join('');
        
        document.body.appendChild(picker);
        const rect = event.currentTarget.getBoundingClientRect();
        picker.style.top = `${rect.bottom + window.scrollY + 5}px`;
        picker.style.left = `${rect.left + window.scrollX - (picker.offsetWidth / 2)}px`;
    }

    async function updateCardColor(idKinerja, colorName) {
        document.querySelector('.color-picker-popup')?.remove();
        const cardElement = document.getElementById(`card-${idKinerja}`);
        if (!cardElement) return;

        Object.keys(softColors).forEach(key => {
            cardElement.classList.remove(softColors[key].bg, softColors[key].border);
        });
        const newColorClasses = softColors[colorName] || softColors['default'];
        cardElement.classList.add(newColorClasses.bg, newColorClasses.border);
        
        try {
            await api.post('updateWarna', { idKinerja, colorName });
        } catch(e) {
            showError(e);
            loadKinerjaData(); // Muat ulang jika gagal
        }
    }

    async function togglePinStatus(idKinerja, isPinned) {
        showLoading('Memperbarui status pin...');
        const newStatus = isPinned ? 0 : 1;
        try {
            await api.post('updatePinStatus', { idKinerja, newStatus });
            await loadKinerjaData();
        } catch (e) {
            showError(e);
        }
    }

    /**
     * ===============================================
     * Modal & Form Handling (Versi Lanjutan)
     * ===============================================
     */
    async function showEditModal(idKinerja) {
        const isNew = idKinerja === null;
        const finalIdKinerja = isNew ? `KIN-${Date.now()}` : idKinerja;
        
        document.getElementById('edit-data-modal')?.remove();

        const colorSwatchesHtml = colorPickerPalette.map(color => `<div class="color-swatch" data-color="${color.name}" style="background-color: ${color.hex}; border: 2px solid ${color.border};"></div>`).join('');

        const modalHtml = `
          <div id="edit-data-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl animate-scale-in flex flex-col max-h-[90vh]">
                <div id="modal-content-area" class="flex-1 p-6 overflow-y-auto">
                    <div class="text-center py-10"><i class="fas fa-spinner fa-spin fa-2x text-indigo-500"></i></div>
                </div>
                <div class="px-6 py-3 bg-slate-50 border-t border-slate-200 flex items-center justify-between rounded-b-xl">
                    <div class="flex items-center gap-4">
                        <button type="button" id="edit-open-label-modal-btn" title="Pilih Kategori" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-indigo-600 rounded-full transition-colors"><i class="fas fa-tag"></i></button>
                        <input type="date" id="form-tanggal" required class="text-sm text-slate-600 bg-transparent border-b-2 border-transparent focus:border-indigo-500 focus:outline-none">
                        <div class="flex items-center gap-2" id="edit-color-picker">${colorSwatchesHtml}<input type="hidden" id="form-warna"></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-700 text-sm rounded-md hover:bg-slate-300">Batal</button>
                        <button type="button" id="modal-save-btn" class="px-4 py-2 bg-slate-800 text-white text-sm font-semibold rounded-md hover:bg-slate-900">${isNew ? 'Tambah' : 'Simpan'}</button>
                    </div>
                </div>
              </div>
          </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const populateModal = (data) => {
            const contentArea = document.getElementById('modal-content-area');
            const [day, month, year] = data.Tanggal ? data.Tanggal.split('/') : [null, null, null];
            
            document.getElementById('form-tanggal').value = data.Tanggal ? `${year}-${month}-${day}` : new Date().toISOString().split('T')[0];
            document.getElementById('form-warna').value = data.Warna || 'default';
            
            contentArea.innerHTML = `
                <textarea id="form-deskripsi" required class="w-full h-48 resize-none focus:outline-none text-slate-800 placeholder-slate-400 text-lg mb-4" placeholder="Tulis sesuatu...">${data.Deskripsi || ''}</textarea>
                <input type="hidden" id="form-kategori" value="${data.Kategori || ''}">
                <div class="space-y-3">
                    <div id="photo-attachment-container"></div>
                    <div id="file-attachment-container"></div>
                </div>`;
            
            renderAttachment('photo', data.Foto, finalIdKinerja);
            renderAttachment('file', data.File, finalIdKinerja);

            document.querySelectorAll('#edit-color-picker .color-swatch').forEach(swatch => {
                swatch.style.outline = (swatch.dataset.color === (data.Warna || 'default')) ? '2px solid #0f172a' : 'none';
            });
        };

        if (isNew) {
            populateModal({});
        } else {
            const response = await api.get('getDataById', { id: idKinerja });
            if (response.status === 'success') {
                populateModal(response.data);
            } else {
                showError(response.message);
                document.getElementById('edit-data-modal').remove();
                return;
            }
        }
        
        document.getElementById('modal-cancel-btn').onclick = () => document.getElementById('edit-data-modal').remove();
        document.getElementById('modal-save-btn').onclick = () => handleSaveKinerja(isNew, finalIdKinerja);
        document.getElementById('edit-open-label-modal-btn').onclick = () => showLabelModal();
        document.getElementById('edit-color-picker').onclick = (e) => {
            if (e.target.classList.contains('color-swatch')) {
                document.querySelectorAll('#edit-color-picker .color-swatch').forEach(el => el.style.outline = 'none');
                e.target.style.outline = '2px solid #0f172a';
                document.getElementById('form-warna').value = e.target.dataset.color;
            }
        };
    }
    
    function renderAttachment(type, url, idKinerja) {
        const container = document.getElementById(`${type}-attachment-container`);
        if (!container) return;
        const columnName = type === 'photo' ? 'Foto' : 'File';
        const acceptType = type === 'photo' ? 'image/*' : '*/*';
        
        let content = '';
        if (url) {
            content = `<div class="flex items-center justify-between p-2 bg-slate-100 rounded-md">
                <a href="${url}" target="_blank" class="flex items-center gap-2 text-sm text-indigo-600 hover:underline truncate">
                    <i class="fas ${type === 'photo' ? 'fa-image' : 'fa-paperclip'}"></i>
                    <span class="truncate">Lihat ${type === 'photo' ? 'Gambar' : 'File'}</span>
                </a>
            </div>`;
        } else {
            content = `<button type="button" onclick="document.getElementById('upload-${type}-input').click()" class="w-full text-left p-2 text-sm text-slate-500 hover:bg-slate-100 rounded-md">
                <i class="fas ${type === 'photo' ? 'fa-camera' : 'fa-upload'} mr-2"></i>Unggah ${type === 'photo' ? 'Gambar' : 'File'}
            </button>
            <input type="file" id="upload-${type}-input" accept="${acceptType}" class="hidden" onchange="handleFileUpload(this, '${idKinerja}', '${columnName}')">`;
        }
        container.innerHTML = content;
    }

    async function handleSaveKinerja(isNew, idKinerja) {
        const btn = document.getElementById('modal-save-btn');
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

        const tanggalValue = document.getElementById('form-tanggal').value;
        const [year, month, day] = tanggalValue.split('-');
        
        let dataObject = {
            'ID Kinerja': idKinerja,
            'Tanggal': `${day}/${month}/${year}`,
            'Deskripsi': document.getElementById('form-deskripsi').value,
            'Kategori': document.getElementById('form-kategori').value,
            'Warna': document.getElementById('form-warna').value
        };

        if (isNew) {
            const tgl = new Date(tanggalValue + 'T00:00:00');
            dataObject = { ...dataObject,
                'Hari': ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'][tgl.getDay()],
                'Bulan': `'${month}`, 'Tahun': year, 'Pin': 0
            };
        }

        try {
            const action = isNew ? 'addNewRow' : 'updateRowData';
            const response = await api.post(action, dataObject);
            if (response.status !== 'success') throw new Error(response.message);
            document.getElementById('edit-data-modal').remove();
            await loadKinerjaData();
        } catch (error) {
            showError(error);
            btn.disabled = false;
            btn.textContent = 'Simpan';
        }
    }
    
    function showDeleteConfirmation(idKinerja) {
        document.getElementById('delete-modal')?.remove();
        const modalHtml = `<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm animate-scale-in"><h3 class="text-lg font-bold text-slate-800">Konfirmasi Hapus</h3><p class="text-sm text-slate-600 mt-2">Yakin ingin menghapus data ini?</p><div class="mt-6 flex justify-end space-x-3"><button id="cancel-delete-btn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">Batal</button><button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Ya, Hapus</button></div></div></div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('cancel-delete-btn').onclick = () => document.getElementById('delete-modal').remove();
        document.getElementById('confirm-delete-btn').onclick = async () => {
             const btn = document.getElementById('confirm-delete-btn');
             btn.disabled = true;
             btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>&nbsp; Menghapus...';
            try {
                await api.post('deleteRow', { idKinerja });
                document.getElementById('delete-modal').remove();
                await loadKinerjaData();
            } catch(error) { showError(error); }
        };
    }
    
    /**
     * ===============================================
     * Helper & Utility Functions
     * ===============================================
     */
    function handleFileUpload(inputElement, idKinerja, columnName) {
        const file = inputElement.files[0];
        if (!file) return;

        const container = document.getElementById(columnName === 'Foto' ? 'photo-attachment-container' : 'file-attachment-container');
        container.innerHTML = `<div class="flex items-center text-sm p-2"><i class="fas fa-spinner fa-spin text-indigo-500"></i><span class="ml-2 text-slate-500">Mengunggah...</span></div>`;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const fileObject = { fileName: file.name, mimeType: file.type, bytes: e.target.result.split(',')[1] };
            try {
                const response = await api.post('uploadFile', { fileObject, idKinerja, columnName });
                if (response.error) throw new Error(response.error);
                renderAttachment(columnName === 'Foto' ? 'photo' : 'file', response.viewerUrl, idKinerja);
            } catch (err) {
                container.innerHTML = `<span class="text-red-600 font-bold text-sm p-2">Gagal: ${err.message}</span>`;
            }
        };
        reader.readAsDataURL(file);
    }
    
    async function showLabelModal() {
        document.getElementById('label-select-modal')?.remove();
        const modalHtml = `<div id="label-select-modal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-[60] p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-xs animate-scale-in flex flex-col"><div class="p-3 border-b border-slate-200"><input type="text" id="label-search-input" placeholder="Cari atau tambah..." class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"></div><div id="label-list-container" class="p-2 flex-1 overflow-y-auto max-h-60"><div class="text-center p-4"><i class="fas fa-spinner fa-spin text-indigo-500"></i></div></div><div class="p-3 bg-slate-50 border-t text-right rounded-b-lg"><button id="apply-label-btn" class="px-4 py-2 bg-slate-800 text-white text-sm font-semibold rounded-md hover:bg-slate-900">Terapkan</button></div></div></div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const listContainer = document.getElementById('label-list-container');
        const searchInput = document.getElementById('label-search-input');
        const kategoriInput = document.getElementById('form-kategori');
        let selectedLabels = (kategoriInput.value || '').split(',').map(l => l.trim()).filter(Boolean);
        
        try {
            const response = await api.get('getLabels');
            if (response.status !== 'success') throw new Error(response.message);
            
            const allLabels = response.data;
            const render = (filter = '') => {
                listContainer.innerHTML = '';
                const filtered = allLabels.filter(l => l.toLowerCase().includes(filter.toLowerCase()));
                filtered.forEach(label => {
                    const isChecked = selectedLabels.includes(label);
                    listContainer.innerHTML += `<label class="flex items-center p-2 rounded-md hover:bg-slate-100 cursor-pointer"><input type="checkbox" data-label="${label}" class="h-4 w-4 rounded border-gray-300" ${isChecked ? 'checked' : ''}><span class="ml-3 text-sm">${label}</span></label>`;
                });
                if (filter && !allLabels.some(l => l.toLowerCase() === filter.toLowerCase())) {
                    listContainer.insertAdjacentHTML('afterbegin', `<div class="p-2 text-sm text-indigo-600 rounded-md hover:bg-indigo-50 cursor-pointer font-semibold add-new-label"><i class="fas fa-plus fa-xs mr-2"></i> Tambah "${filter}"</div>`);
                }
            };
            
            listContainer.onclick = (e) => {
                if (e.target.closest('.add-new-label')) {
                    const newLabel = searchInput.value.trim();
                    if (newLabel && !allLabels.includes(newLabel)) allLabels.push(newLabel);
                    if (newLabel && !selectedLabels.includes(newLabel)) selectedLabels.push(newLabel);
                    searchInput.value = '';
                    render();
                }
            };
            
            listContainer.onchange = (e) => {
                if (e.target.type === 'checkbox') {
                    const label = e.target.dataset.label;
                    if (e.target.checked) {
                        if (!selectedLabels.includes(label)) selectedLabels.push(label);
                    } else {
                        selectedLabels = selectedLabels.filter(l => l !== label);
                    }
                }
            };

            searchInput.oninput = () => render(searchInput.value);
            document.getElementById('apply-label-btn').onclick = () => {
                kategoriInput.value = selectedLabels.join(', ');
                document.getElementById('label-select-modal').remove();
            };
            render();
        } catch(e) {
            listContainer.innerHTML = `<p class="p-2 text-red-600">${e.message}</p>`;
        }
    }

    function extractIdFromUrl(url) {
        if (!url) return null;
        const match = url.match(/[-\w]{25,}/);
        return match ? match[0] : null;
    }
  </script>

</body>
</html>

